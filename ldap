getconf src = /var/lib/ldap
getconf dest = /var/backups/ldap
getconf conf = /etc/ldap/slapd.conf
getconf databases = all
getconf compress = yes
getconf SLAPCAT = /usr/bin/slapcat

error=0
now="$(date +"%Y%m%d")"

# Decide if the handler should operate on a vserver or on the host.
# In the former case, check that $vsname exists and is running.
usevserver=no
vroot=''
if [ $vservers_are_available = yes ]; then
   if [ -n "$vsname" ]; then
      # does it exist ?
      if ! vservers_exist "$vsname" ; then
         fatal "The vserver given in vsname ($vsname) does not exist."
      fi
      # is it running ?
      vservers_running $vsname || fatal "The vserver $vsname is not running."
      # everything ok
      info "Using vserver '$vsname'."
      usevserver=yes
      vroot="$VROOTDIR/$vsname"
   else
      info "No vserver name specified, actions will be performed on the host."
   fi
fi

cd $vroot$src

if [ $databases = all ]; then
   databases=$(find . -mindepth 1 -maxdepth 1 -type d)
fi

for db in $databases
do
   ret=`mkdir -p $vroot$tmp/$db 2>&1`
   code=$?
   if [ "$ret" ]; then
      debug "$ret"
   fi
   if [ $code != 0 ]; then
      error "command failed mkdir -p $vroot$tmp/$db"
   fi

   if [ $usevserver = yes ]
   then
      ret=`$VSERVER $vsname exec $SLAPCAT $src/$db | bzip2 > $tmp/$db/$db-$now.ldif.bz2  2>&1`
   else
      ret=`$SLAPCAT $src/$db | bzip2 > $tmp/$db/$db-$now.ldif.bz2 2>&1`
   fi
   code=$?
   if [ "$ret" ]; then
      debug "$ret"
   fi
   if [ $code != 0 ]; then
      error "command failed -- $SVNDUMP $vroot$src/$db > $vroot$tmp/$db/$db-$now.ldif.bz2"
      error=1
   fi
done

if [ $error -eq 1 ]; then
   echo "Error: because of earlier errors, we are leaving ldap backups in $vroot$tmp instead of $vroot$dest"
else
   if [ -d $vroot$dest -a -d $vroot$tmp ]; then
      rm -rf $vroot$dest
   fi
   if [ -d $vroot$tmp ]; then
      mv $vroot$tmp $vroot$dest
   fi
fi

exit 0

